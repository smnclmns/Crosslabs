{% extends "base.html" %}

{% block title %}
Automated Titration
{% endblock %}

{% block header %}

<link rel="stylesheet" href="{{ url_for('static', filename='css/main.css')}}"> <!-- Link to the main CSS file -->

{% endblock %}

{% block main %}
<div class="container">
    <form action="#" method="post">
        <div class="row g-4"> <!-- Row for the Responses and the graphical Outputs from the Arduino -->
            <div class="tabs">
                <h3 id="tablist-1" class="d-flex justify-content-center">Arduino Responses</h3>
                <div role="tablist" aria-labelledby="tablist-1" class="manual">
                    <button id="tab-1" type="button" role="tab" aria-selected="true" aria-controls="tabpanel-1">
                        <span class="focus">Terminal</span>
                    </button>
                    <button id="tab-2" type="button" role="tab" aria-selected="false" aria-controls="tabpanel-2">
                        <span class="focus">Commands</span>
                    </button>
                </div> <!-- Tablist for the different outputs -->
                <div id="tabpanel-1" role="tabpanel" aria-labelledby="tab-1">
                    <pre id="terminal">
> Arduino output{% if connected == True %}
> Arduino is connected
{{ log }}
<input id="query-input" type="text" placeholder="> Type in query..." name="query-input">{% endif %}{% if connected == False %}
<input id="query-input" type="text" placeholder="> Arduino not connected" name="query-input" disabled>
<input id="connect" value="connect" name="connect" type="hidden">
<form action="#" method="post"><button type="submit" class="btn col-12 button-5">CONNECT</button></form>{% endif %}
                    </pre>
                </div> <!-- Tabpanel for the Terminal Output -->
                <div id="tabpanel-2" role="tabpanel" aria-labelledby="tab-2" class="is-hidden">
                    <div>
                        <!-- Use the same path for the picture -->
                        <img id="command-picture" src="/create_plot" alt="Command Picture">
                        <div id="tabpanel-1" role="tabpanel" aria-labelledby="tab-1">
                          <pre id="terminal">
> Arduino output
                    </div>
                </div> <!-- Tabpanel for the Commands -->
            </div> <!-- Tabs for the different outputs -->
        </div> <!-- Row for the Responses and the graphical Outputs from the Arduino -->
    </form>
</div> <!-- Container for the whole page -->
<div class="container text-center">

  <div id="arduino-buttons" class="row g-0" hidden > <!-- Row for the buttons and the revolutions input -->
    <button type="submit" name="query-input" value="Start" id="start-btn" class="btn col-12 button-5">Start</button>
    <button type="submit" name="query-input" value="Stop" id="stop-btn" class="btn col-12 button-5">Stop</button>
    <button type="submit" name="query-input" value="Reset" id="reset-btn" class="btn col-12 button-5">Reset</button>
    <button type="submit" name="query-input" value="mock" id="mock-btn" class="btn col-12 button-5">Mock</button>
  </div>



<div class="row g-0"> <!-- Row for the valve position -->

</div>
</div> <!-- Container for the buttons and the slider -->

{% endblock %}

{% block script %}

<script>
/*
 *   This content is licensed according to the W3C Software License at
 *   https://www.w3.org/Consortium/Legal/2015/copyright-software-and-document
 *
 *   File:   tabs-manual.js
 *
 *   Desc:   Tablist widget that implements ARIA Authoring Practices
 */

'use strict';

class TabsManual {
  constructor(groupNode) {
    this.tablistNode = groupNode;

    this.tabs = [];

    this.firstTab = null;
    this.lastTab = null;

    this.tabs = Array.from(this.tablistNode.querySelectorAll('[role=tab]'));
    this.tabpanels = [];

    for (var i = 0; i < this.tabs.length; i += 1) {
      var tab = this.tabs[i];
      var tabpanel = document.getElementById(tab.getAttribute('aria-controls'));

      tab.tabIndex = -1;
      tab.setAttribute('aria-selected', 'false');
      this.tabpanels.push(tabpanel);

      tab.addEventListener('keydown', this.onKeydown.bind(this));
      tab.addEventListener('click', this.onClick.bind(this));

      if (!this.firstTab) {
        this.firstTab = tab;
      }
      this.lastTab = tab;
    }

    this.setSelectedTab(this.firstTab);
  }

  setSelectedTab(currentTab) {
    for (var i = 0; i < this.tabs.length; i += 1) {
      var tab = this.tabs[i];
      if (currentTab === tab) {
        tab.setAttribute('aria-selected', 'true');
        tab.removeAttribute('tabindex');
        this.tabpanels[i].classList.remove('is-hidden');
      } else {
        tab.setAttribute('aria-selected', 'false');
        tab.tabIndex = -1;
        this.tabpanels[i].classList.add('is-hidden');
      }
    }
  }

  moveFocusToTab(currentTab) {
    currentTab.focus();
  }

  moveFocusToPreviousTab(currentTab) {
    var index;

    if (currentTab === this.firstTab) {
      this.moveFocusToTab(this.lastTab);
    } else {
      index = this.tabs.indexOf(currentTab);
      this.moveFocusToTab(this.tabs[index - 1]);
    }
  }

  moveFocusToNextTab(currentTab) {
    var index;

    if (currentTab === this.lastTab) {
      this.moveFocusToTab(this.firstTab);
    } else {
      index = this.tabs.indexOf(currentTab);
      this.moveFocusToTab(this.tabs[index + 1]);
    }
  }

  /* EVENT HANDLERS */

  onKeydown(event) {
    var tgt = event.currentTarget,
      flag = false;

    switch (event.key) {
      case 'ArrowLeft':
        this.moveFocusToPreviousTab(tgt);
        flag = true;
        break;

      case 'ArrowRight':
        this.moveFocusToNextTab(tgt);
        flag = true;
        break;

      case 'Home':
        this.moveFocusToTab(this.firstTab);
        flag = true;
        break;

      case 'End':
        this.moveFocusToTab(this.lastTab);
        flag = true;
        break;

      default:
        break;
    }

    if (flag) {
      event.stopPropagation();
      event.preventDefault();
    }
  }

  // Since this example uses buttons for the tabs, the click onr also is activated
  // with the space and enter keys
  onClick(event) {
    this.setSelectedTab(event.currentTarget);
  }
}
// Initialize tablist

window.addEventListener('load', function () {
  var tablists = document.querySelectorAll('[role=tablist].manual');
  for (var i = 0; i < tablists.length; i++) {
    new TabsManual(tablists[i]);
  }

});


  document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('tab-2').addEventListener('click', function() {
        // Show buttons when Tab 2 is active
        document.getElementById('arduino-buttons').removeAttribute('hidden');

        document.getElementById('tab-1').disabled = true;
    });
});


</script>



{% if is_titrating == True %}
<script>
  setInterval(function() {
    var d = new Date();
    document.getElementById("plot").src = "/create_plot?ver=" + d.getTime();
  }, 2000);
</script>

<script>
  setInterval(function() {
    var xhr = new XMLHttpRequest();
    xhr.open('GET', '/read_serial', true);
    xhr.send();
  }, 1000);
</script>
<script>
// Function to send commands to the Arduino
function sendCommand(command) {
    var xhr = new XMLHttpRequest();
    xhr.open('POST', '/send_command', true);
    xhr.setRequestHeader('Content-Type', 'application/json');
    xhr.onload = function () {
        if (xhr.status === 200) {
            console.log('Command sent successfully');
        } else {
            console.error('Error sending command');
        }
    };
    xhr.send(JSON.stringify({ command: command }));
}

// Event handler for the "Start Titration" button
document.getElementById('start-titration').addEventListener('click', function () {
    sendCommand('start-titration');
});

// Event handler for the "Stop Titration" button
document.getElementById('stop-titration').addEventListener('click', function () {
    sendCommand('stop-titration');
});
</script>
{% endif %}

<!-- {% if connected == True %}
<script>
  setInterval(function() {
    var d = new Date();
    document.getElementById("terminal");
  }, 1000);
</script>
{% endif %} -->

{% endblock %}